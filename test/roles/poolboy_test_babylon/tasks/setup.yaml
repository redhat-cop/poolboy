---
- name: Create test namespace
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ poolboy_test_namespace }}"

- name: Create anarchy test namespace
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ poolboy_test_babylon_anarchy_namespace }}"

- name: Create poolboy/anarchy RBAC
  k8s:
    definition: "{{ lookup('template', _template) }}"
  loop:
  - clusterrole.yaml.j2
  - clusterrolebinding.yaml.j2
  - role.yaml.j2
  - rolebinding.yaml.j2
  loop_control:
    loop_var: _template

- name: Cleanup Test Resources
  include_tasks: cleanup-resources.yaml

- name: Process template for Anarchy CRDs and ClusterRoles
  command: >-
    oc process --local -f https://raw.githubusercontent.com/redhat-cop/anarchy/master/install-template.yaml -o json
  register: r_oc_process_anarchy_install

- name: Create anarchy install resources
  k8s:
    definition: "{{ _resource }}"
  loop: "{{ r_oc_process_anarchy_install.stdout | from_json | json_query('items') }}"
  loop_control:
    loop_var: _resource
    label: "{{ _resource.kind }} {{ _resource.metadata.name }}"

- name: Process template for Anarchy Deployment
  command: >-
    oc process --local -f https://raw.githubusercontent.com/redhat-cop/anarchy/master/deploy-template.yaml -o json
  register: r_oc_process_anarchy_deploy

- name: Deploy Anarchy for Poolboy Test
  k8s:
    namespace: "{{ poolboy_test_babylon_anarchy_namespace }}"
    definition: "{{ _resource }}"
  loop: "{{ r_oc_process_anarchy_deploy.stdout | from_json | json_query('items') }}"
  loop_control:
    loop_var: _resource
    label: "{{ _resource.kind }} {{ _resource.metadata.name }}"
